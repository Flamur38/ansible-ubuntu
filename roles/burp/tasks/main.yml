---
# --------------------------------------------------
# Install NSS tools (for Firefox cert import)
# --------------------------------------------------
- name: Install NSS tools
  become: true
  ansible.builtin.apt:
    name: libnss3-tools
    state: present

# --------------------------------------------------
# Find Firefox profile directory
# --------------------------------------------------
- name: Locate Firefox profiles directory
  become: false
  ansible.builtin.find:
    paths: "/home/{{ ansible_env.SUDO_USER }}/.mozilla/firefox"
    patterns: "*.default*"
    file_type: directory
  register: firefox_profiles

# --------------------------------------------------
# Fail if no Firefox profile exists
# --------------------------------------------------
- name: Ensure Firefox profile exists
  ansible.builtin.fail:
    msg: "No Firefox profile found. Start Firefox once before running this role."
  when: firefox_profiles.matched == 0

# --------------------------------------------------
# Import Burp CA certificate
# --------------------------------------------------
- name: Import Burp CA into Firefox
  become: false
  ansible.builtin.command: >
    certutil -A
    -n "Burp Suite CA"
    -t "C,,"
    -i "{{ role_path }}/files/burp-ca.der"
    -d sql:{{ firefox_profiles.files[0].path }}
  args:
    creates: "{{ firefox_profiles.files[0].path }}/cert9.db"
